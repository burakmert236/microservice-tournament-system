services:
  # Infrastructure
  redis:
    image: redis:7-alpine
    ports: 
      - "6379:6379"
    command: redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
  dynamodb:
    image: amazon/dynamodb-local
    container_name: dynamodb
    ports:
      - "8000:8000"
    command: -jar DynamoDBLocal.jar -sharedDb -dbPath /home/dynamodblocal/data
    volumes:
      - dynamodb_data:/home/dynamodblocal/data
    user: root
    healthcheck:
      test: ["CMD-SHELL", "curl -s -o /dev/null -w '%{http_code}' http://localhost:8000 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5
  dynamodb-init:
    image: amazon/aws-cli
    container_name: dynamodb-init
    depends_on:
      dynamodb:
        condition: service_healthy
    volumes:
      - ./schemas:/tmp/dynamo
    environment:
      AWS_ACCESS_KEY_ID: 'FAKEID'
      AWS_SECRET_ACCESS_KEY: 'FAKEKEY'
      AWS_REGION: 'us-west-2'
    entrypoint: /bin/bash
    command: >
      -c "
        for f in /tmp/dynamo/*.json; do 
          echo 'Creating table from $$f...';
          aws dynamodb create-table --endpoint-url http://dynamodb:8000 --cli-input-json file://$$f || echo 'Table already exists or creation failed for: '$$f;
        done
      "

  # Microservices
  leaderboard-service:
    container_name: leaderboard-service
    build: 
      context: ./
      dockerfile: ./services/leaderboard-service/Dockerfile
    depends_on:
      - redis
      - dynamodb
    environment:
      - DEBUG_FLAG=true
      - REDIS_ADDR=redis:6379
      - REDIS_PASSWORD=
      - REDIS_DB=0
      - REDIS_POOL_SIZE=20
      - REDIS_MAX_RETRIES=3
      - REDIS_DIAL_TIMEOUT=5s
      - REDIS_READ_TIMEOUT=3s
      - REDIS_WRITE_TIMEOUT=3s
    ports:
      - "8010:8010"
  user-service:
    container_name: user-service
    build: 
      context: ./
      dockerfile: ./services/user-service/Dockerfile
    depends_on:
      - dynamodb
    environment:
      - DEBUG_FLAG=true
    ports:
      - "9090:9090"
  
volumes:
  redis_data:
  dynamodb_data: